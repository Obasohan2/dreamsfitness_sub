{% extends "base.html" %}
{% load static %}
{% load cart_tools %}

{% block page_header %}
<div class="container header-container mb-4">
    <div class="row">
        <div class="col text-center">
            <h2 class="logo-font mt-3 text-black">Shopping Cart</h2>
            <hr class="w-25 mx-auto">
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="overlay"></div>

<div class="container mb-5">

{% if has_products or has_subscription %}

<div class="table-responsive">
<table class="table table-sm align-middle">

    <!-- TABLE HEAD -->
    <thead class="text-black border-bottom">
        <tr>
            <th class="pl-3">Product</th>
            <th class="pl-3">Price</th>
            <th class="pl-2 text-center" style="width:180px;">Qty</th>
            <th class="text-right pr-5" style="width:160px;">Subtotal</th>
        </tr>
    </thead>

    <tbody>

    <!-- PRODUCTS -->
    {% for item in cart_items %}
    <tr>

        <!-- PRODUCT -->
        <td class="pl-3">
            <div class="d-flex align-items-center">
                <img src="{{ item.product.images.url }}"
                     alt="{{ item.product.name }}"
                     class="rounded mr-3"
                     style="width:90px;height:90px;object-fit:cover;">
                <strong class="text-black">{{ item.product.name }}</strong>
            </div>
        </td>

        <!-- PRICE -->
        <td class="pl-3">
            £{{ item.product.price|floatformat:2 }}
        </td>

        <!-- QTY -->
        <td class="text-center">
            <form method="POST"
                  action="{% url 'adjust_cart' item.item_id %}"
                  class="update-form d-inline-block">
                {% csrf_token %}

                <div class="d-flex justify-content-center align-items-center">
                    <button type="button"
                            class="btn btn-dark btn-sm decrement-qty mr-2"
                            data-item_id="{{ item.item_id }}">
                        −
                    </button>

                    <input type="number"
                           name="quantity"
                           value="{{ item.quantity }}"
                           min="1" max="99"
                           class="form-control form-control-sm text-center"
                           style="width:55px;"
                           id="id_qty_{{ item.item_id }}">

                    <button type="button"
                            class="btn btn-dark btn-sm increment-qty ml-2"
                            data-item_id="{{ item.item_id }}">
                        +
                    </button>
                </div>
            </form>

            <!-- UPDATE / REMOVE -->
            <div class="d-flex justify-content-center mt-2">
                <a class="update-link text-info small mr-4">Update</a>
                <a class="remove-item text-danger small"
                   id="remove_{{ item.item_id }}">
                    <i class="fas fa-trash-alt mr-1"></i>Remove
                </a>
            </div>
        </td>

        <!-- SUBTOTAL -->
        <td class="text-right pr-5">
            <strong>
                £{{ item.product.price|calc_subtotal:item.quantity|floatformat:2 }}
            </strong>
        </td>

    </tr>
    {% endfor %}

    <!-- SUBSCRIPTION -->
    {% if has_subscription %}
    <tr class="table-info">

        <td class="pl-3">
            <strong class="text-black">{{ subscription_item.plan.title }}</strong>
            <div class="small text-muted">
                {{ subscription_item.months }} month{{ subscription_item.months|pluralize }} subscription
            </div>
        </td>

        <td class="pl-3">
            £{{ subscription_item.plan.price|floatformat:2 }}
            <span class="text-muted small">/ month</span>
        </td>

        <td class="text-center">
            <strong>{{ subscription_item.months }} mo</strong>
        </td>

        <td class="text-right pr-2">
            <div class="d-flex justify-content-end align-items-center">
                <strong class="mr-3">
                    £{{ subscription_pre_discount_total|floatformat:2 }}
                </strong>
                <a href="{% url 'remove_subscription_from_cart' %}"
                   class="text-danger">
                    <i class="fas fa-trash-alt"></i>
                </a>
            </div>
        </td>

    </tr>
    {% endif %}

    </tbody>

    <!-- FOOTER -->
    <tfoot>
        <tr>
            <td colspan="4" class="text-right pt-4">

                {% if has_products %}
                <h6>Product Cart Total: £{{ total|floatformat:2 }}</h6>
                <h6>Delivery: £{{ delivery|floatformat:2 }}</h6>
                <h6>Product Subtotal: £{{ product_grand_total|floatformat:2 }}</h6>
                {% endif %}

                {% if has_subscription %}
                <h6 class="mt-2">
                    Subscription (before discount):
                    £{{ subscription_pre_discount_total|floatformat:2 }}
                </h6>

                {% if subscription_discount_amount > 0 %}
                <h6 class="text-success">
                    Discount −£{{ subscription_discount_amount|floatformat:2 }}
                    ({{ subscription_item.discount.total_discount }}%)
                </h6>
                {% endif %}

                <h6>
                    Subscription (after discount):
                    £{{ subscription_after_discount|floatformat:2 }}
                </h6>
                {% endif %}

                <hr>

                <h4 class="mt-2">
                    <strong>Grand Total: £{{ grand_total|floatformat:2 }}</strong>
                </h4>

            </td>
        </tr>

        <tr>
            <td colspan="4" class="text-right">
                <a href="{% url 'products' %}" class="btn btn-outline-dark mr-2">
                    <i class="fas fa-chevron-left mr-1"></i>Continue Shopping
                </a>
                <a href="{% url 'checkout' %}" class="btn btn-dark">
                    <i class="fas fa-lock mr-1"></i>Secure Checkout
                </a>
            </td>
        </tr>
    </tfoot>

</table>
</div>

{% else %}

<div class="text-center py-5">
    <i class="fas fa-shopping-cart fa-4x text-muted"></i>
    <p class="lead mt-3">Your cart is empty.</p>
    <a href="{% url 'products' %}" class="btn btn-outline-dark mt-2">
        <i class="fas fa-chevron-left mr-1"></i>Visit Shop
    </a>
</div>

{% endif %}
</div>
{% endblock %}

{% block postloadjs %}
{{ block.super }}
{% include 'products/includes/quantity_input_script.html' %}

<script>
$('.update-link').on('click', function () {
    $(this).closest('td').find('form').submit();
});

$('.remove-item').on('click', function () {
    const csrfToken = "{{ csrf_token }}";
    const itemId = this.id.replace('remove_', '');
    const url = "{% url 'remove_from_cart' 'ITEM_ID' %}".replace('ITEM_ID', itemId);

    $.post(url, { csrfmiddlewaretoken: csrfToken }).done(() => location.reload());
});
</script>
{% endblock %}
