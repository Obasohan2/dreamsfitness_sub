{% extends "base.html" %}
{% load static %}
{% load cart_tools %}

{% block page_header %}
<div class="container header-container mb-4">
    <div class="row">
        <div class="col text-center">
            <h2 class="logo-font mt-3 text-black">Shopping Cart</h2>
            <hr class="w-25 mx-auto">
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="overlay"></div>

<div class="container mb-5">

{% if has_products or has_subscription %}

<div class="table-responsive">
<table class="table table-sm">

    <!-- TABLE HEAD -->
    <thead class="text-black border-bottom">
        <tr>
            <th class="d-none d-sm-table-cell pl-3">Product</th>
            <th></th>
            <th class="pl-3">Price</th>
            <th class="pl-3" style="width:140px;">Qty</th>
            <th class="text-right pr-5" style="width:160px;">Subtotal</th>
        </tr>
    </thead>

    <!-- TABLE BODY -->
    <tbody>

    {% for item in cart_items %}
    <tr>

        <!-- Image -->
        <td class="d-none d-sm-table-cell pl-3">
            <img src="{{ item.product.images.url }}"
                 alt="{{ item.product.name }}"
                 class="rounded img-fluid"
                 style="height:110px;width:110px;object-fit:cover;">
        </td>

        <!-- Name -->
        <td>
            <strong class="text-black">{{ item.product.name }}</strong>
        </td>

        <!-- Price -->
        <td class="text-black pl-3">
            £{{ item.product.price|floatformat:2 }}
        </td>

        <!-- Quantity -->
        <td class="pl-3">
            <form method="POST"
                  action="{% url 'adjust_cart' item.item_id %}"
                  class="update-form">
                {% csrf_token %}

                <div class="input-group input-group-sm">
                    <div class="input-group-prepend">
                        <button type="button"
                                class="btn btn-dark decrement-qty"
                                data-item_id="{{ item.item_id }}">
                            <i class="fas fa-minus"></i>
                        </button>
                    </div>

                    <input type="number"
                           name="quantity"
                           value="{{ item.quantity }}"
                           min="1" max="99"
                           class="form-control text-center qty_input"
                           id="id_qty_{{ item.item_id }}"
                           data-item_id="{{ item.item_id }}">

                    <div class="input-group-append">
                        <button type="button"
                                class="btn btn-dark increment-qty"
                                data-item_id="{{ item.item_id }}">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
            </form>

            <!-- Update / Remove -->
            <div class="d-flex align-items-center mt-2">
                <a class="update-link text-info small">Update</a>

                <a class="remove-item text-danger small ml-auto d-flex align-items-center"
                   id="remove_{{ item.item_id }}">
                    <i class="fas fa-trash-alt mr-1"></i> Remove
                </a>
            </div>
        </td>

        <!-- Subtotal -->
        <td class="text-black text-right pr-3">
            <strong>
                £{{ item.product.price|calc_subtotal:item.quantity|floatformat:2 }}
            </strong>
        </td>

    </tr>
    {% endfor %}

    <!-- SUBSCRIPTION -->
    {% if has_subscription %}
    <tr class="table-info">

        <td colspan="2" class="pl-3">
            <strong class="text-black">
                {{ subscription_item.plan.title }}
            </strong>
            <div class="small text-muted">
                {{ subscription_item.months }} month{% if subscription_item.months > 1 %}s{% endif %} subscription
            </div>
        </td>

        <td class="pl-3">
            £{{ subscription_item.plan.price|floatformat:2 }}
            <span class="text-muted small">/ month</span>
        </td>

        <td class="pl-3">
            <strong>{{ subscription_item.months }} mo</strong>
        </td>

        <!-- TABLE SUBTOTAL = BEFORE DISCOUNT -->
        <td class="text-right pr-3">
            <div class="d-flex justify-content-end align-items-center">
                <strong class="text-black mr-3">
                    £{{ subscription_pre_discount_total|floatformat:2 }}
                </strong>

                <button type="button"
                        class="btn btn-link p-0 text-danger"
                        onclick="location.href='{% url 'remove_subscription_from_cart' %}'"
                        aria-label="Remove subscription">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </div>
        </td>

    </tr>
    {% endif %}

    </tbody>

    <!-- FOOTER -->
    <tfoot>
        <tr>
            <td colspan="5" class="text-right pt-4">

                {% if has_products %}
                <h6 class="text-black">
                    Product Cart Total: £{{ total|floatformat:2 }}
                </h6>

                <h6 class="text-black">
                    Delivery: £{{ delivery|floatformat:2 }}
                </h6>

                <h6 class="text-black">
                    Product Subtotal: £{{ product_grand_total|floatformat:2 }}
                </h6>
                {% endif %}

                {% if has_subscription %}
                <h6 class="text-black mt-2">
                    Subscription (before discount):
                    £{{ subscription_pre_discount_total|floatformat:2 }}
                </h6>

                {% if subscription_discount_amount > 0 %}
                <h6 class="text-success">
                    Discount:
                    −£{{ subscription_discount_amount|floatformat:2 }}
                    ({{ subscription_item.discount.total_discount }}%)
                </h6>
                {% endif %}

                <h6 class="text-black">
                    Subscription (after discount):
                    £{{ subscription_after_discount|floatformat:2 }}
                </h6>
                {% endif %}

                <hr>

                <h4 class="mt-2 text-black">
                    <strong>Grand Total: £{{ grand_total|floatformat:2 }}</strong>
                </h4>

            </td>
        </tr>

        <tr>
            <td colspan="5" class="text-right">
                <a href="{% url 'products' %}" class="btn btn-outline-dark mr-2">
                    <i class="fas fa-chevron-left mr-1"></i> Continue Shopping
                </a>

                <a href="{% url 'checkout' %}" class="btn btn-dark">
                    <i class="fas fa-lock mr-1"></i> Secure Checkout
                </a>
            </td>
        </tr>
    </tfoot>

</table>
</div>

{% else %}

<div class="d-flex flex-column align-items-center justify-content-center py-5 text-center">
    <i class="fas fa-shopping-cart fa-4x text-muted"></i>
    <p class="lead text-black mt-3">Your cart is empty.</p>
    <a href="{% url 'products' %}" class="btn btn-outline-dark mt-2">
        <i class="fas fa-chevron-left mr-1"></i> Visit Shop
    </a>
</div>

{% endif %}

</div>
{% endblock %}



{% block postloadjs %}
{{ block.super }}
{% include 'products/includes/quantity_input_script.html' %}

<script>
/* =========================
   UPDATE PRODUCT QTY
========================= */
$('.update-link').on('click', function () {
    $(this).closest('td').find('form').submit();
});

/* =========================
   REMOVE PRODUCT FROM CART
========================= */
$('.remove-item').on('click', function () {
    const csrfToken = "{{ csrf_token }}";
    const itemId = this.id.replace('remove_', '');
    const url = "{% url 'remove_from_cart' 'ITEM_ID' %}".replace('ITEM_ID', itemId);

    $.post(url, { csrfmiddlewaretoken: csrfToken })
        .done(function () {
            location.reload();
        });
});
</script>
{% endblock %}
