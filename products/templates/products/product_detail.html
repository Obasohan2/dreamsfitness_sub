{% extends "base.html" %}
{% load crispy_forms_tags %}
{% load static %}

{% block page_header %}
    <div class="container header-container">
        <div class="row">
            <div class="col text-center">
                <h2 class="logo-font mt-4">Product Details</h2>
            </div>
        </div>
    </div>
{% endblock %}

{% block content %}
    <div class="overlay"></div>

    <div class="container mt-4">

        <!-- ================= PRODUCT ================= -->
        <div class="row">

            <!-- IMAGE -->
            <div class="col-12 col-md-6 mb-4">
                {% if product.images %}
                    <img
                        src="{{ product.images.url }}"
                        class="img-fluid rounded shadow-sm w-100"
                        alt="{{ product.name }}"
                        style="object-fit: cover; max-height: 400px;"
                    >
                {% else %}
                    <img
                        src="{{ MEDIA_URL }}photos/noimage.png"
                        class="img-fluid rounded shadow-sm w-100"
                        alt="No image available"
                        style="object-fit: cover; max-height: 400px;"
                    >
                {% endif %}
            </div>

            <!-- DETAILS -->
            <div class="col-12 col-md-6">

                <h1 class="mb-2">{{ product.name }}</h1>

                {% if product.category %}
                    <p class="text-muted mb-2">
                        <a href="{% url 'products' %}?category={{ product.category.name }}">
                            {{ product.category.name }}
                        </a>
                    </p>
                {% endif %}

                {% if product.rating %}
                    <span class="badge badge-warning text-dark mb-2">
                        {{ product.rating|floatformat:1 }}
                        <i class="fas fa-star"></i>
                    </span>
                {% endif %}

                {% if request.user.is_staff %}
                    <p class="mt-2">
                        <a href="{% url 'edit_product' product.id %}">Edit</a> |
                        <a
                            href="{% url 'delete_product' product.id %}"
                            class="text-danger"
                        >
                            Delete
                        </a>
                    </p>
                {% endif %}

                <p class="mt-4">
                    {{ product.description }}
                </p>

                <h3 class="text-primary mt-3">
                    £{{ product.price|floatformat:2 }}
                </h3>

                <!-- ADD TO CART -->
                {% if product.stock > 0 %}
                    {% if not request.user.is_staff %}
                        <form
                            method="POST"
                            action="{% url 'add_to_cart' product.id %}"
                            class="mt-3"
                        >
                            {% csrf_token %}

                            <input
                                type="hidden"
                                name="redirect_url"
                                value="{{ request.path }}"
                            >

                            <div class="d-flex align-items-center mb-3">

                                <button
                                    type="button"
                                    class="btn btn-dark btn-sm decrement-qty mr-2"
                                    id="decrement-qty_{{ product.id }}"
                                    data-item_id="{{ product.id }}"
                                    disabled
                                >
                                    −
                                </button>

                                <input
                                    type="number"
                                    name="quantity"
                                    value="1"
                                    min="1"
                                    max="{{ product.stock }}"
                                    class="form-control form-control-sm text-center qty_input"
                                    style="width: 100px;"
                                    id="id_qty_{{ product.id }}"
                                    data-item_id="{{ product.id }}"
                                >

                                <button
                                    type="button"
                                    class="btn btn-dark btn-sm increment-qty ml-2"
                                    id="increment-qty_{{ product.id }}"
                                    data-item_id="{{ product.id }}"
                                >
                                    +
                                </button>

                            </div>

                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-shopping-cart mr-1"></i>
                                Add to Cart
                            </button>

                        </form>
                    {% else %}
                        <div class="alert alert-info mt-3">
                            Admin accounts cannot add items to cart.
                        </div>
                    {% endif %}
                {% else %}
                    <div class="alert alert-danger mt-3">
                        This product is currently out of stock.
                    </div>
                {% endif %}

                <!-- NAV -->
                <div class="mt-4">
                    <a
                        href="{% url 'products' %}"
                        class="btn btn-outline-secondary mr-2"
                    >
                        <i class="fas fa-arrow-left mr-1"></i>
                        Keep Shopping
                    </a>

                    <a
                        href="{% url 'view_cart' %}"
                        class="btn btn-primary"
                    >
                        View Cart
                        <i class="fas fa-arrow-right ml-1"></i>
                    </a>
                </div>

            </div>
        </div>

        <hr class="my-5">

        <!-- ================= REVIEWS ================= -->
        <div class="row justify-content-center">
            <div class="col-12 col-md-6">

                <h3 class="mb-4 text-center">
                    Reviews
                </h3>

                {% for review in product.reviews.all %}
                    <div class="card mb-3">
                        <div class="card-body">

                            <div class="d-flex justify-content-between align-items-center">
                                <strong>
                                    {{ review.user.username }}
                                </strong>

                                <div class="text-warning">
                                    {% for i in "12345" %}
                                        {% if forloop.counter <= review.rating %}
                                            <i class="fas fa-star"></i>
                                        {% else %}
                                            <i class="far fa-star"></i>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </div>

                            <small class="text-muted d-block mb-2">
                                {{ review.created|date:"F j, Y, g:i A" }}
                            </small>

                            <h6 class="font-weight-bold">
                                {{ review.title }}
                            </h6>

                            <p class="mb-3">
                                {{ review.comment }}
                            </p>

                            {% if request.user == review.user %}
                                <div class="d-flex">

                                    <a
                                        href="{% url 'edit_review' review.id %}"
                                        class="btn btn-sm btn-outline-info mr-2"
                                    >
                                        <i class="fas fa-edit"></i>
                                        Edit
                                    </a>

                                    <button
                                        type="button"
                                        class="btn btn-sm btn-outline-danger"
                                        data-toggle="modal"
                                        data-target="#deleteReviewModal{{ review.id }}"
                                    >
                                        <i class="fas fa-trash-alt"></i>
                                        Delete
                                    </button>

                                </div>
                            {% endif %}

                        </div>
                    </div>

                    <!-- DELETE REVIEW MODAL -->
                    <div
                        class="modal fade"
                        id="deleteReviewModal{{ review.id }}"
                        tabindex="-1"
                        role="dialog"
                        aria-hidden="true"
                    >
                        <div class="modal-dialog modal-dialog-centered" role="document">
                            <div class="modal-content">

                                <div class="modal-header">
                                    <h5 class="modal-title">
                                        Delete Review
                                    </h5>
                                    <button
                                        type="button"
                                        class="close"
                                        data-dismiss="modal"
                                    >
                                        <span>&times;</span>
                                    </button>
                                </div>

                                <div class="modal-body">
                                    Are you sure you want to delete your review for
                                    <strong>{{ product.name }}</strong>?
                                    <br>
                                    <small class="text-muted">
                                        This action cannot be undone.
                                    </small>
                                </div>

                                <div class="modal-footer">
                                    <button
                                        type="button"
                                        class="btn btn-outline-secondary"
                                        data-dismiss="modal"
                                    >
                                        Cancel
                                    </button>

                                    <form
                                        method="POST"
                                        action="{% url 'delete_review' review.id %}"
                                    >
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-danger">
                                            Yes, delete
                                        </button>
                                    </form>
                                </div>

                            </div>
                        </div>
                    </div>

                {% empty %}
                    <div class="alert alert-info text-center">
                        No reviews yet. Be the first to review this product.
                    </div>
                {% endfor %}

                <!-- ================= REVIEW FORM ================= -->
                {% if request.user.is_authenticated %}
                    {% if not has_reviewed %}
                        <div class="card mt-4">
                            <div class="card-body">
                                <h4 class="mb-3">
                                    Write a Review
                                </h4>

                                <form method="POST">
                                    {% csrf_token %}
                                    {{ review_form|crispy }}

                                    <button
                                        type="submit"
                                        class="btn btn-primary mt-3"
                                    >
                                        Submit Review
                                    </button>
                                </form>
                            </div>
                        </div>
                    {% else %}
                        <div class="alert alert-secondary mt-4 text-center">
                            You have already reviewed this product.
                        </div>
                    {% endif %}
                {% else %}
                    <div class="alert alert-warning mt-4 text-center">
                        <a
                            href="{% url 'account_login' %}?next={{ request.path }}"
                            class="alert-link"
                        >
                            Sign in
                        </a>
                        to leave a review.
                    </div>
                {% endif %}

            </div>
        </div>

    </div>
{% endblock %}

{% block postloadjs %}
    {{ block.super }}
    {% include "products/includes/quantity_input_script.html" %}
{% endblock %}
