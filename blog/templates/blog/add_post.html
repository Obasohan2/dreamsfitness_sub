{% extends "base.html" %}
{% load static %}
{% load crispy_forms_tags %}

{% block extra_title %}
    Add Post
{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/posts.css' %}">
{% endblock %}

{% block page_header %}
    <div class="container header-container">
        <div class="row">
            <div class="col"></div>
        </div>
    </div>
{% endblock %}

{% block content %}
    <div class="overlay"></div>

    <div class="container">
        <div class="row">
            <div class="col-12 col-md-6">
                <hr>
                <h2>- Success Story -</h2>
                <p class="text-muted">Share Success</p>
                <hr>
            </div>
        </div>

        <div class="row">
            <div class="col-12 col-md-6">

                <form
                    action="{% url 'add_post' %}"
                    method="POST"
                    enctype="multipart/form-data"
                    class="form mb-2"
                >
                    {% csrf_token %}

                    <!-- All non-image fields -->
                    {% for field in form %}
                        {% if field.name != 'image' %}
                            {{ field|as_crispy_field }}
                        {% endif %}
                    {% endfor %}

                    <!-- Image field (custom, no crispy) -->
                    <div class="form-group">
                        <label
                            for="{{ form.image.id_for_label }}"
                            class="font-weight-bold"
                        >
                            Upload Image (optional)
                        </label>

                        <input
                            type="file"
                            name="{{ form.image.name }}"
                            id="{{ form.image.id_for_label }}"
                            class="form-control-file"
                            accept="image/*"
                            onchange="previewImage(this)"
                        >

                        <!-- Image Preview -->
                        <div
                            class="mt-3 d-none"
                            id="imagePreviewWrapper"
                        >
                            <img
                                id="imagePreview"
                                class="img-fluid rounded border"
                                style="max-height: 300px; object-fit: contain;"
                                alt="Image preview"
                            >
                        </div>

                        {% if form.image.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.image.errors }}
                            </div>
                        {% endif %}
                    </div>

                    <!-- Actions -->
                    <div class="mt-3">
                        <button type="submit" class="btn btn-black">
                            Submit
                        </button>
                    </div>

                </form>

            </div>
        </div>
    </div>

    <!-- Image Preview JS -->
    <script>
        function previewImage(input) {
            const wrapper = document.getElementById('imagePreviewWrapper');
            const img = document.getElementById('imagePreview');

            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    img.src = e.target.result;
                    wrapper.classList.remove('d-none');
                };
                reader.readAsDataURL(input.files[0]);
            } else {
                img.src = '';
                wrapper.classList.add('d-none');
            }
        }
    </script>
{% endblock %}
